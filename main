#!/bin/bash
set -e

export LLVM_UTIL_ROOT=$(dirname $(realpath ${BASH_SOURCE[0]}))

usage() {
  cat <<EOF
Usage: $(basename "$0") <subcommand> [args...]

LLVM project build utility.

Subcommands:
  build       Incremental build using ninja
  rebuild     Full clean build with CMake configuration
  clean       Remove the build directory
  check       Run test targets (check-<target>)
  run         Build and execute a binary
  debug       Build and launch a binary in lldb
  test        Run tests using llvm-lit
  format      Format code changes using clang-format-diff
  show-path   Print the path to a built binary

Options:
  -h, --help  Show this help message

Environment:
  LLVM_PROJECT_ROOT  Override the LLVM project directory

Run '$(basename "$0") <subcommand> -h' for subcommand-specific help.
EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  usage
  exit 0
fi

function set_llvm_project_root() {
  if [ -v LLVM_PROJECT_ROOT ]; then
    >&2 echo "llvm-project root is set to $LLVM_PROJECT_ROOT"
  else
    CWD=$(pwd)
    while [[ $CWD != "/" && $(basename $CWD) != "llvm-project" ]]; do
      CWD=$(dirname $CWD)
    done

    if [[ $(basename $CWD) == "llvm-project" ]]; then
      export LLVM_PROJECT_ROOT=$CWD
      >&2 echo "Using CWD as llvm-project root: $LLVM_PROJECT_ROOT"
    else
      export LLVM_PROJECT_ROOT=$HOME/llvm-project/
      >&2 echo "Using default llvm-project root: $LLVM_PROJECT_ROOT"
    fi
  fi
}

if [ -z "$1" ]; then
  >&2 echo "Error: Missing subcommand."
  >&2 echo
  usage >&2
  exit 2
fi

SUBCOMMAND="$1"
SUBCOMMAND_PATH=$LLVM_UTIL_ROOT/subcommands/$SUBCOMMAND

if ! [ -f $SUBCOMMAND_PATH ]; then
  >&2 echo "Subcommand '$SUBCOMMAND' not found"
  exit 2
fi

set_llvm_project_root

$SUBCOMMAND_PATH ${@:2}
