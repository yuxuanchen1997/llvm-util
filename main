#!/bin/sh
set -e

export LLVM_UTIL_ROOT=$(dirname $(realpath ${BASH_SOURCE[0]}))

CWD=$(pwd)
while [[ $CWD != "/" && $(basename $CWD) != "llvm-project" ]]; do
  CWD=$(dirname $CWD)
done

if [[ $(basename $CWD) == "llvm-project" ]]; then
  export LLVM_PROJECT_ROOT=$CWD
else
  echo "Using default llvm-project root: $HOME/llvm-project/"
  export LLVM_PROJECT_ROOT=$HOME/llvm-project/
fi

if ! [[ -d $LLVM_PROJECT_ROOT ]]; then
  echo "Did not find llvm-project root!"
  exit 1
fi

if [ -z "$1" ]; then
  echo "Missing subcommand. Possible subcommands are"
  ls $LLVM_UTIL_ROOT/subcommands
  exit 2
fi

SUBCOMMAND="$1"
SUBCOMMAND_PATH=$LLVM_UTIL_ROOT/subcommands/$SUBCOMMAND

if ! [ -f $SUBCOMMAND_PATH ]; then
  echo "Subcommand '$SUBCOMMAND' not found"
  exit 2
fi

$SUBCOMMAND_PATH ${@:2}
