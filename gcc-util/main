#!/bin/bash
set -e

export GCC_UTIL_ROOT=$(dirname $(realpath ${BASH_SOURCE[0]}))

usage() {
  cat <<EOF
Usage: $(basename "$0") <subcommand> [args...]

GCC project build utility.

Subcommands:
  build       Incremental build using ninja (CMake) or make (autotools)
  rebuild     Full clean build with CMake or configure
  clean       Remove the build directory
  check       Run test suites (check-<target>)
  run         Build and execute a binary
  debug       Build and launch a binary in gdb
  test        Run tests using dejagnu
  format      Format code changes using clang-format-diff
  show-path    Print the path to a built binary
  install-deps  Install required build dependencies (Fedora)
  save-tests    Save test .sum files with a label
  compare-tests Compare two saved test snapshots

Options:
  -h, --help  Show this help message

Environment:
  GCC_PROJECT_ROOT  Override the GCC project directory

Run '$(basename "$0") <subcommand> -h' for subcommand-specific help.
EOF
}

if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  usage
  exit 0
fi

function set_gcc_project_root() {
  if [ -v GCC_PROJECT_ROOT ]; then
    >&2 echo "gcc-project root is set to $GCC_PROJECT_ROOT"
  else
    CWD=$(pwd)
    while [[ "$CWD" != "/" && $(basename "$CWD") != "gcc" ]]; do
      CWD=$(dirname "$CWD")
    done

    if [[ $(basename "$CWD") == "gcc" ]]; then
      export GCC_PROJECT_ROOT="$CWD"
      >&2 echo "Using CWD as gcc-project root: $GCC_PROJECT_ROOT"
    else
      export GCC_PROJECT_ROOT="$HOME/gcc/"
      >&2 echo "Using default gcc-project root: $GCC_PROJECT_ROOT"
    fi
  fi
}

if [ -z "$1" ]; then
  >&2 echo "Error: Missing subcommand."
  >&2 echo
  usage >&2
  exit 2
fi

SUBCOMMAND="$1"
SUBCOMMAND_PATH="$GCC_UTIL_ROOT/subcommands/$SUBCOMMAND"

if ! [ -f "$SUBCOMMAND_PATH" ]; then
  >&2 echo "Subcommand '$SUBCOMMAND' not found"
  exit 2
fi

set_gcc_project_root

# Detect build system: prefer gcc-cmake if present, fall back to autotools.
if [ -d "$GCC_PROJECT_ROOT/gcc-cmake" ]; then
  export GCC_USE_CMAKE=1
  export GCC_BUILD_DIR="$GCC_PROJECT_ROOT/build"
  export GCC_INSTALL_DIR="$GCC_PROJECT_ROOT/install"
  >&2 echo "Build system: CMake (gcc-cmake detected)"
else
  export GCC_USE_CMAKE=0
  export GCC_BUILD_DIR="$GCC_PROJECT_ROOT/build"
  export GCC_INSTALL_DIR="$GCC_PROJECT_ROOT/install"
  >&2 echo "Build system: autotools"
fi

"$SUBCOMMAND_PATH" "${@:2}"
